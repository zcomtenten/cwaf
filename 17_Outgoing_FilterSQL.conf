# ---------------------------------------------------------------
# Comodo ModSecurity Rules
# Copyright (C) 2020 Comodo Security solutions All rights reserved.
#
# The COMODO SECURITY SOLUTIONS Mod Security Rule Set is distributed under
# THE COMODO SECURITY SOLUTIONS END USER LICENSE AGREEMENT,
# Please see the enclosed LICENCE file for full details.
# ---------------------------------------------------------------
# This is a FILE CONTAINING CHANGED or MODIFIED RULES FROM THE:
# OWASP ModSecurity Core Rule Set (CRS)
# ---------------------------------------------------------------

SecRule RESPONSE_BODY "@pmFromFile bl_output_sql" \
	"id:214650,msg:'COMODO WAF: Start track SQL Information Leakage||%{tx.domain}|%{tx.mode}|2',phase:4,pass,setvar:'tx.sql_error_match=1',nolog,t:none,rev:2,severity:2,tag:'CWAF',tag:'FilterSQL'"

SecRule TX:sql_error_match "@eq 1" \
	"id:218010,chain,msg:'COMODO WAF: Microsoft Access SQL Information Leakage||%{tx.domain}|%{tx.mode}|2',phase:4,capture,block,logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',ctl:auditLogParts=+E,t:none,rev:1,severity:2,tag:'CWAF',tag:'FilterSQL'"
SecRule RESPONSE_BODY "@rx (?i)(?:JET Database Engine|Access Database Engine|\[Microsoft\]\[ODBC Microsoft Access Driver\])" \
	"setvar:'tx.outgoing_points=+%{tx.points_limit4}',setvar:'tx.sqli_points=+%{tx.points_limit4}',setvar:'tx.points=+%{tx.points_limit4}',t:none"

SecRule TX:sql_error_match "@eq 1" \
	"id:218020,chain,msg:'COMODO WAF: Oracle SQL Information Leakage||%{tx.domain}|%{tx.mode}|2',phase:4,capture,block,logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',ctl:auditLogParts=+E,t:none,rev:1,severity:2,tag:'CWAF',tag:'FilterSQL'"
SecRule RESPONSE_BODY "@pm ora- java.sql oracle oci_ ora_" \
	"chain,t:none"
SecRule MATCHED_VAR "@rx (?i)(?:ORA-[0-9][0-9][0-9][0-9]|java\.sql\.SQLException|Oracle error|Oracle.*Driver|Warning.*oci_.*|Warning.*ora_.*)" \
	"setvar:'tx.outgoing_points=+%{tx.points_limit4}',setvar:'tx.sqli_points=+%{tx.points_limit4}',setvar:'tx.points=+%{tx.points_limit4}'"

SecRule TX:sql_error_match "@eq 1" \
	"id:218030,chain,msg:'COMODO WAF: DB2 SQL Information Leakage||%{tx.domain}|%{tx.mode}|2',phase:4,capture,block,logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',ctl:auditLogParts=+E,t:none,rev:2,severity:2,tag:'CWAF',tag:'FilterSQL'"
SecRule RESPONSE_BODY "@pm error: [ibm] db2 db2_" \
	"chain,t:none"
SecRule MATCHED_VAR "@rx (?i)(?:DB2 SQL error:|\[IBM\]\[CLI Driver\]\[DB2/6000\]|CLI Driver.*DB2|DB2 SQL error|db2_\w+\()" \
	"setvar:'tx.points=+%{tx.points_limit4}',setvar:'tx.sqli_points=+%{tx.points_limit4}',setvar:'tx.outgoing_points=+%{tx.points_limit4}'"

SecRule TX:sql_error_match "@eq 1" \
	"id:218040,chain,msg:'EMC SQL Information Leakage||%{tx.domain}|%{tx.mode}|2',phase:4,capture,block,logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',ctl:auditLogParts=+E,t:none,rev:1,severity:2,tag:'CWAF',tag:'FilterSQL'"
SecRule RESPONSE_BODY "@rx (?i)(?:\[DM_QUERY_E_SYNTAX\]|has occurred in the vicinity of:)" \
	"setvar:'tx.sqli_points=+%{tx.points_limit4}',setvar:'tx.points=+%{tx.points_limit4}',setvar:'tx.outgoing_points=+%{tx.points_limit4}'"

SecRule TX:sql_error_match "@eq 1" \
	"id:218050,chain,msg:'COMODO WAF: Firebird SQL Information Leakage||%{tx.domain}|%{tx.mode}|2',phase:4,capture,block,logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',ctl:auditLogParts=+E,t:none,rev:1,severity:2,tag:'CWAF',tag:'FilterSQL'"
SecRule RESPONSE_BODY "@rx (?i)(?:Dynamic SQL Error)" \
	"setvar:'tx.points=+%{tx.points_limit4}',setvar:'tx.sqli_points=+%{tx.points_limit4}',setvar:'tx.outgoing_points=+%{tx.points_limit4}'"

SecRule TX:sql_error_match "@eq 1" \
	"id:218060,chain,msg:'COMODO WAF: Frontbase SQL Information Leakage||%{tx.domain}|%{tx.mode}|2',phase:4,capture,block,logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',ctl:auditLogParts=+E,rev:1,severity:2,tag:'CWAF',tag:'FilterSQL'"
SecRule RESPONSE_BODY "@contains transaction rollback." \
	"chain,t:none,t:lowercase"
SecRule MATCHED_VAR "@rx (?i)(?:Exception (condition )?\d+\. Transaction rollback\.)" \
	"setvar:'tx.points=+%{tx.points_limit4}',setvar:'tx.sqli_points=+%{tx.points_limit4}',setvar:'tx.outgoing_points=+%{tx.points_limit4}'"

SecRule TX:sql_error_match "@eq 1" \
	"id:218070,chain,msg:'COMODO WAF: hsqldb SQL Information Leakage||%{tx.domain}|%{tx.mode}|2',phase:4,capture,block,logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',ctl:auditLogParts=+E,t:none,rev:1,severity:2,tag:'CWAF',tag:'FilterSQL'"
SecRule RESPONSE_BODY "@rx (?i)(?:org\.hsqldb\.jdbc)" \
	"setvar:'tx.points=+%{tx.points_limit4}',setvar:'tx.sqli_points=+%{tx.points_limit4}',setvar:'tx.outgoing_points=+%{tx.points_limit4}'"

SecRule TX:sql_error_match "@eq 1" \
	"id:218080,chain,msg:'COMODO WAF: informix SQL Information Leakage||%{tx.domain}|%{tx.mode}|2',phase:4,capture,block,logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',ctl:auditLogParts=+E,t:none,rev:1,severity:2,tag:'CWAF',tag:'FilterSQL'"
SecRule RESPONSE_BODY "@pm illegal informix" \
	"chain,t:none"
SecRule MATCHED_VAR "@rx (?i)(?:An illegal character has been found in the statement|com\.informix\.jdbc|Exception.*Informix)" \
	"setvar:'tx.points=+%{tx.points_limit4}',setvar:'tx.sqli_points=+%{tx.points_limit4}',setvar:'tx.outgoing_points=+%{tx.points_limit4}',t:none"

SecRule TX:sql_error_match "@eq 1" \
	"id:218090,chain,msg:'COMODO WAF: ingres SQL Information Leakage||%{tx.domain}|%{tx.mode}|2',phase:4,capture,block,logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',ctl:auditLogParts=+E,t:none,rev:1,severity:2,tag:'CWAF',tag:'FilterSQL'"
SecRule RESPONSE_BODY "@contains ingres" \
	"chain,t:lowercase,t:none"
SecRule MATCHED_VAR "@rx (?i)(?:Warning.*ingres_|Ingres SQLSTATE|Ingres\W.*Driver)" \
	"setvar:'tx.points=+%{tx.points_limit4}',setvar:'tx.sqli_points=+%{tx.points_limit4}',setvar:'tx.outgoing_points=+%{tx.points_limit4}'"

SecRule TX:sql_error_match "@eq 1" \
	"id:218110,chain,msg:'COMODO WAF: interbase SQL Information Leakage||%{tx.domain}|%{tx.mode}|2',phase:4,capture,block,logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',ctl:auditLogParts=+E,t:none,rev:1,severity:2,tag:'CWAF',tag:'FilterSQL'"
SecRule RESPONSE_BODY "@rx (?i)(?:<b>Warning</b>: ibase_|Unexpected end of command in statement)" \
	"setvar:'tx.points=+%{tx.points_limit4}',setvar:'tx.sqli_points=+%{tx.points_limit4}',setvar:'tx.outgoing_points=+%{tx.points_limit4}'"

SecRule TX:sql_error_match "@eq 1" \
	"id:218120,chain,msg:'COMODO WAF: maxDB SQL Information Leakage||%{tx.domain}|%{tx.mode}|2',phase:4,capture,block,logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',ctl:auditLogParts=+E,t:none,rev:1,severity:2,tag:'CWAF',tag:'FilterSQL'"
SecRule RESPONSE_BODY "@pm pos maxdb" \
	"chain,t:none"
SecRule MATCHED_VAR "@rx (?i)(?:SQL error.*POS([0-9]+).*|Warning.*maxdb.*)" \
	"setvar:'tx.points=+%{tx.points_limit4}',setvar:'tx.sqli_points=+%{tx.points_limit4}',setvar:'tx.outgoing_points=+%{tx.points_limit4}'"

SecRule TX:sql_error_match "@eq 1" \
	"id:218130,chain,msg:'COMODO WAF: mssql SQL Information Leakage||%{tx.domain}|%{tx.mode}|2',phase:4,capture,block,logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',ctl:auditLogParts=+E,t:none,rev:1,severity:2,tag:'CWAF',tag:'FilterSQL'"
SecRule RESPONSE_BODY "@pm .OleDb. [Microsoft] [Macromedia] [SqlException .SqlClient. Unclosed '80040e14' mssql_query() OLE Incorrect Sintaxis Syntax Procedure expression. ADODB.Field select mssql_ SQL" \
	"chain,t:none"
SecRule MATCHED_VAR "@rx (?i)(?:System\.Data\.OleDb\.OleDbException|\[Microsoft\]\[ODBC SQL Server Driver\]|\[Macromedia\]\[SQLServer JDBC Driver\]|\[SqlException|System\.Data\.SqlClient\.SqlException|Unclosed quotation mark after the character string|'80040e14'|mssql_query\(\)|Microsoft OLE DB Provider for ODBC Drivers|Microsoft OLE DB Provider for SQL Server|Incorrect syntax near|Sintaxis incorrecta cerca de|Syntax error in string in query expression|Procedure or function .* expects parameter|Unclosed quotation mark before the character string|Syntax error .* in query expression|Data type mismatch in criteria expression\.|ADODB\.Field \(0x800A0BCD\)|the used select statements have different number of columns|OLE DB.*SQL Server|Warning.*mssql_.*|Driver.*SQL[\-\_\ ]*Server|SQL Server.*Driver|SQL Server.*[0-9a-fA-F]{8}|Exception.*\WSystem\.Data\.SqlClient\.)" \
	"setvar:'tx.points=+%{tx.points_limit4}',setvar:'tx.sqli_points=+%{tx.points_limit4}',setvar:'tx.outgoing_points=+%{tx.points_limit4}'"

SecRule TX:sql_error_match "@eq 1" \
	"id:218140,chain,msg:'COMODO WAF: mysql SQL Information Leakage||%{tx.domain}|%{tx.mode}|2',phase:4,capture,block,logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',ctl:auditLogParts=+E,t:none,rev:1,severity:2,tag:'CWAF',tag:'FilterSQL'"
SecRule RESPONSE_BODY "@pm MySQL count mysql_fetch_array() syntax; SQL [MySQL] Table mysql_ MySqlClient." \
	"chain,t:none"
SecRule MATCHED_VAR "@rx (?i)(?:supplied argument is not a valid MySQL|Column count doesn't match value count at row|mysql_fetch_array\(\)|on MySQL result index|You have an error in your SQL syntax;|You have an error in your SQL syntax near|MySQL server version for the right syntax to use|\[MySQL\]\[ODBC|Column count doesn't match|Table '[^']+' doesn't exist|SQL syntax.*MySQL|Warning.*mysql_.*|valid MySQL result|MySqlClient\.)" \
	"setvar:'tx.points=+%{tx.points_limit4}',setvar:'tx.sqli_points=+%{tx.points_limit4}',setvar:'tx.outgoing_points=+%{tx.points_limit4}'"

SecRule TX:sql_error_match "@eq 1" \
	"id:218150,chain,msg:'COMODO WAF: postgres SQL Information Leakage||%{tx.domain}|%{tx.mode}|2',phase:4,capture,block,logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',ctl:auditLogParts=+E,t:none,rev:1,severity:2,tag:'CWAF',tag:'FilterSQL'"
SecRule RESPONSE_BODY "@pm PostgreSQL pg_query() pg_exec() pg_ Npgsql. PG::" \
	"chain,t:none"
SecRule MATCHED_VAR "@rx (?i)(?:PostgreSQL query failed:|pg_query\(\) \[:|pg_exec\(\) \[:|PostgreSQL.*ERROR|Warning.*pg_.*|valid PostgreSQL result|Npgsql\.|PG::([a-zA-Z]*)Error|Supplied argument is not a valid PostgreSQL (?:.*?) resource|Unable to connect to PostgreSQL server)" \
	"setvar:'tx.points=+%{tx.points_limit4}',setvar:'tx.sqli_points=+%{tx.points_limit4}',setvar:'tx.outgoing_points=+%{tx.points_limit4}'"

SecRule TX:sql_error_match "@eq 1" \
	"id:218160,chain,msg:'COMODO WAF: sqlite SQL Information Leakage||%{tx.domain}|%{tx.mode}|2',phase:4,capture,block,logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',ctl:auditLogParts=+E,t:none,rev:1,severity:2,tag:'CWAF',tag:'FilterSQL'"
SecRule RESPONSE_BODY "@pm sqlite_ SQLite3:: SQLite .Exception .SQLiteException" \
	"chain,t:none"
SecRule MATCHED_VAR "@rx (?i)(?:Warning.*sqlite_.*|Warning.*SQLite3::|SQLite\/?JDBCDriver|SQLite\.Exception|System\.Data\.SQLite\.SQLiteException)" \
	"setvar:'tx.points=+%{tx.points_limit4}',setvar:'tx.sqli_points=+%{tx.points_limit4}',setvar:'tx.outgoing_points=+%{tx.points_limit4}'"

SecRule TX:sql_error_match "@eq 1" \
	"id:218170,chain,msg:'COMODO WAF: Sybase SQL Information Leakage||%{tx.domain}|%{tx.mode}|2',phase:4,capture,block,logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',ctl:auditLogParts=+E,t:none,rev:1,severity:2,tag:'CWAF',tag:'FilterSQL'"
SecRule RESPONSE_BODY "@contains Sybase" \
	"chain,t:none,t:lowercase"
SecRule MATCHED_VAR "@rx (?i)(?:Sybase message:|Warning.*sybase.*|Sybase.*Server message.*)" \
	"setvar:'tx.points=+%{tx.points_limit4}',setvar:'tx.sqli_points=+%{tx.points_limit4}',setvar:'tx.outgoing_points=+%{tx.points_limit4}'"

